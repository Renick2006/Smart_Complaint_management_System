<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #eef2f7, #f7f9fc);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        .dashboard-wrap {
            max-width: 1200px;
        }

        .card {
            border-radius: 16px;
        }

        .shadow-soft {
            box-shadow: 0 10px 25px rgba(16, 24, 40, 0.08);
        }

        .hover-card {
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .hover-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 35px rgba(16, 24, 40, 0.12);
        }

        .chart-box {
            height: 270px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .mini-title {
            font-weight: 700;
            letter-spacing: 0.2px;
            color: #0f172a;
        }

        .subtext {
            color: #64748b;
            font-size: 0.95rem;
        }

        .badge-soft {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
        }

        .badge-pending {
            background: rgba(239, 68, 68, 0.12);
            color: #b91c1c;
        }

        .badge-resolved {
            background: rgba(34, 197, 94, 0.14);
            color: #15803d;
        }

        .table thead th {
            font-size: 0.9rem;
            color: #334155;
            border-bottom: 1px solid #e5e7eb;
        }

        .table td {
            vertical-align: middle;
        }

        .progress {
            height: 10px;
            border-radius: 999px;
        }

        .progress-bar {
            border-radius: 999px;
        }

        .small-pill {
            font-size: 0.85rem;
            font-weight: 700;
            color: #0f172a;
            background: #eef2ff;
            padding: 6px 10px;
            border-radius: 999px;
        }
    </style>
</head>

<body>

<div class="container my-4 dashboard-wrap">

    <!-- HEADER -->
    <div class="position-relative mb-4">
        <h2 class="text-center m-0 fw-bold">Admin Dashboard</h2>
        <div class="subtext text-center mt-1">
            Interactive complaint analytics & resolution tracking
        </div>

        <a href="/logout" class="btn btn-outline-danger btn-sm position-absolute top-0 end-0">
            Logout
        </a>
    </div>

    <!-- PIE CHARTS -->
    <div class="row g-3 mb-3">

        <!-- Billing -->
        <div class="col-md-3">
            <div class="card shadow-soft border-0 hover-card">
                <div class="card-body text-center chart-box">
                    <div class="mini-title mb-2">Billing</div>
                    <canvas id="BillingChart" style="cursor:pointer;"></canvas>
                </div>
            </div>
        </div>

        <!-- Delivery -->
        <div class="col-md-3">
            <div class="card shadow-soft border-0 hover-card">
                <div class="card-body text-center chart-box">
                    <div class="mini-title mb-2">Delivery</div>
                    <canvas id="DeliveryChart" style="cursor:pointer;"></canvas>
                </div>
            </div>
        </div>

        <!-- Product -->
        <div class="col-md-3">
            <div class="card shadow-soft border-0 hover-card">
                <div class="card-body text-center chart-box">
                    <div class="mini-title mb-2">Product</div>
                    <canvas id="ProductChart" style="cursor:pointer;"></canvas>
                </div>
            </div>
        </div>

        <!-- Overall -->
        <div class="col-md-3">
            <div class="card shadow-soft border-0 hover-card">
                <div class="card-body text-center chart-box">
                    <div class="mini-title mb-2">Overall Categories</div>
                    <canvas id="overallCategoryChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <!-- PROGRESS BARS -->
    <div class="row g-3 mb-4">

        <div class="col-md-4">
            <div class="card shadow-soft border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="mini-title">Billing Resolved %</div>
                        <div class="small-pill" id="billingPercent">0%</div>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="billingBar" style="width: 0%"></div>
                    </div>
                    <div class="subtext mt-2" id="billingCounts"></div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-soft border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="mini-title">Delivery Resolved %</div>
                        <div class="small-pill" id="deliveryPercent">0%</div>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="deliveryBar" style="width: 0%"></div>
                    </div>
                    <div class="subtext mt-2" id="deliveryCounts"></div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-soft border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="mini-title">Product Resolved %</div>
                        <div class="small-pill" id="productPercent">0%</div>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="productBar" style="width: 0%"></div>
                    </div>
                    <div class="subtext mt-2" id="productCounts"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- FILTERED COMPLAINTS -->
    <div class="card shadow-soft border-0">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 id="complaintTitle" class="m-0 fw-semibold"></h5>
                <span class="subtext" id="hintText">Click a chart to load complaints</span>
            </div>

            <!-- SEARCH + SORT -->
            <div class="row g-2 mt-3">
                <div class="col-md-8">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by email or complaint...">
                </div>

                <div class="col-md-4">
                    <select id="sortSelect" class="form-select">
                        <option value="latest">Sort: Latest</option>
                        <option value="urgencyHigh">Sort: Urgency (High → Low)</option>
                        <option value="urgencyLow">Sort: Urgency (Low → High)</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover mt-3" id="complaintTable" style="display:none;">
                    <thead>
                        <tr>
                            <th style="width:120px;">Acknowledge</th>
                            <th style="width:220px;">Email</th>
                            <th>Complaint</th>
                            <th style="width:100px;">Urgency</th>
                            <th style="width:120px;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="complaintBody"></tbody>
                </table>
            </div>

        </div>
    </div>

</div>

<script>
/*
DB row structure:
0 id
1 email
2 complaint
3 category
4 urgency
5 priority
6 status
7 created_at
8 resolved_at
*/
const complaints = {{ complaints | tojson }};
const stats = {{ stats | tojson }};

// ------------------------------
// STATUS PIE CHARTS
// ------------------------------
function createStatusPieChart(category, resolvedColor, pendingColor) {
    const ctx = document.getElementById(category + "Chart");

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Resolved', 'Pending'],
            datasets: [{
                data: [
                    stats[category]?.Resolved || 0,
                    stats[category]?.Pending || 0
                ],
                backgroundColor: [resolvedColor, pendingColor]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            onClick: () => filterComplaints(category)
        }
    });
}

// Updated professional palette
createStatusPieChart("Billing",  "#22c55e", "#ef4444");
createStatusPieChart("Delivery", "#06b6d4", "#f97316");
createStatusPieChart("Product",  "#8b5cf6", "#64748b");


// ------------------------------
// OVERALL CATEGORY PIE CHART
// ------------------------------
function getCategoryCounts() {
    const counts = {};
    complaints.forEach(c => {
        const category = c[3];
        counts[category] = (counts[category] || 0) + 1;
    });
    return counts;
}

const categoryCounts = getCategoryCounts();

new Chart(document.getElementById("overallCategoryChart"), {
    type: "pie",
    data: {
        labels: Object.keys(categoryCounts),
        datasets: [{
            data: Object.values(categoryCounts),
            backgroundColor: ['#3b82f6', '#a855f7', '#f59e0b', '#10b981']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: "bottom" }
        }
    }
});


// ------------------------------
// RESOLVED % PROGRESS BARS
// ------------------------------
function setProgress(category, percentId, barId, countsId) {
    const resolved = stats[category]?.Resolved || 0;
    const pending = stats[category]?.Pending || 0;
    const total = resolved + pending;

    const percent = total === 0 ? 0 : Math.round((resolved / total) * 100);

    document.getElementById(percentId).innerText = percent + "%";
    document.getElementById(barId).style.width = percent + "%";
    document.getElementById(countsId).innerText =
        `Resolved: ${resolved} | Pending: ${pending} | Total: ${total}`;
}

setProgress("Billing", "billingPercent", "billingBar", "billingCounts");
setProgress("Delivery", "deliveryPercent", "deliveryBar", "deliveryCounts");
setProgress("Product", "productPercent", "productBar", "productCounts");


// ------------------------------
// SEARCH + SORT + FILTER
// ------------------------------
let currentFiltered = [];

function urgencyRank(u) {
    if (u === "High") return 3;
    if (u === "Medium") return 2;
    return 1;
}

function renderTable(rows) {
    const tbody = document.getElementById("complaintBody");
    tbody.innerHTML = "";

    rows.forEach(c => {
        const status = c[6];

        const statusBadge = (status === "Pending")
            ? `<span class="badge-soft badge-pending">Pending</span>`
            : `<span class="badge-soft badge-resolved">Resolved</span>`;

        const checkedAttr = (status === "Resolved") ? "checked disabled" : "";

        tbody.innerHTML += `
            <tr>
                <td>
                    <input type="checkbox"
                        ${checkedAttr}
                        onclick="acknowledgeComplaint(${c[0]}, this)">
                </td>
                <td>${c[1]}</td>
                <td>${c[2]}</td>
                <td>${c[4]}</td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });
}

function applySearchAndSort() {
    let rows = [...currentFiltered];

    const q = document.getElementById("searchInput").value.toLowerCase().trim();
    if (q) {
        rows = rows.filter(c =>
            c[2].toLowerCase().includes(q) || c[1].toLowerCase().includes(q)
        );
    }

    const sortMode = document.getElementById("sortSelect").value;

    if (sortMode === "urgencyHigh") {
        rows.sort((a, b) => urgencyRank(b[4]) - urgencyRank(a[4]));
    } else if (sortMode === "urgencyLow") {
        rows.sort((a, b) => urgencyRank(a[4]) - urgencyRank(b[4]));
    } else {
        rows.sort((a, b) => b[0] - a[0]);
    }

    renderTable(rows);
}

function filterComplaints(category) {
    currentFiltered = complaints.filter(c => c[3] === category);

    document.getElementById("complaintTitle").innerText =
        `${category} Complaints (${currentFiltered.length})`;

    document.getElementById("hintText").innerText =
        "Search, sort, and tick checkbox to resolve complaints";

    document.getElementById("complaintTable").style.display = "table";

    document.getElementById("searchInput").value = "";
    document.getElementById("sortSelect").value = "latest";

    applySearchAndSort();
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("searchInput").addEventListener("input", applySearchAndSort);
    document.getElementById("sortSelect").addEventListener("change", applySearchAndSort);
});


// ------------------------------
// ACKNOWLEDGE COMPLAINT (AJAX)
// ------------------------------
function acknowledgeComplaint(id, checkbox) {
    fetch(`/acknowledge/${id}`, { method: "POST" })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("Failed to update complaint");
        }
    })
    .catch(() => alert("Server error"));
}
</script>

</body>
</html>
